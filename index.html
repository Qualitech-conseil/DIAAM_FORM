<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulaire Produits</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
h2 { margin-top: 30px; }
.category-block { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
.limit-msg { color: red; font-size: 13px; display: none; }
.logo { max-width: 180px; margin-bottom: 20px; }
button { padding: 12px 20px; font-size: 16px; }
</style>
</head>

<body>

<img id="logo" class="logo" src="" alt="Logo client">

<h1>Votre sélection</h1>
<div id="form-container"></div>

<button id="submitBtn">Envoyer</button>
<p id="status"></p>

<script type="module">
/* ------------ Paramètres Supabase ------------ */
const SUPABASE_URL = "https://vawvmiosgslvykfqxffs.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhd3ZtaW9zZ3NsdnlrZnF4ZmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjcxNTAsImV4cCI6MjA3OTU0MzE1MH0.T_q5fT1PCOt_pwEFdoKqePFYp7N4IXZSN1XA3HGG5v8";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

/* ------------ Récupération du client ------------ */
const params = new URLSearchParams(window.location.search);
const clientId = params.get("client") || "client_1";

/* ------------ Chargement config client ------------ */
async function loadConfig() {
    const res = await fetch(`clients/${clientId}.json`);
    return res.json();
}

function buildForm(config) {
    document.getElementById("logo").src = config.logo;

    const container = document.getElementById("form-container");

    Object.entries(config.categories).forEach(([category, products]) => {

        const block = document.createElement("div");
        block.className = "category-block";

        const title = document.createElement("h2");
        title.textContent = category;

        const limitMsg = document.createElement("div");
        limitMsg.className = "limit-msg";
        limitMsg.textContent = "Vous ne pouvez sélectionner que 5 produits.";

        block.appendChild(title);
        block.appendChild(limitMsg);

        products.forEach(product => {
            const id = `${category}_${product}`;
            block.innerHTML += `
                <label>
                    <input type="checkbox" name="${category}" value="${product}"> 
                    ${product}
                </label><br>
            `;
        });

        block.innerHTML += `
            <label>Autre : <input type="text" name="${category}_other"></label>
        `;

        container.appendChild(block);
    });

    attachSelectionLimit();
}

function attachSelectionLimit() {
    document.querySelectorAll(".category-block").forEach(block => {
        const checkboxes = block.querySelectorAll("input[type=checkbox]");
        const limitMsg = block.querySelector(".limit-msg");

        checkboxes.forEach(cb => {
            cb.addEventListener("change", () => {
                const selected = [...checkboxes].filter(x => x.checked);
                if (selected.length > 5) {
                    cb.checked = false;
                    limitMsg.style.display = "block";
                    setTimeout(() => limitMsg.style.display = "none", 1500);
                }
            });
        });
    });
}

/* ------------ Soumission ------------ */
async function submitForm(config) {
    const payload = {};

    Object.entries(config.categories).forEach(([category]) => {
        const selected = [
            ...document.querySelectorAll(`input[name="${category}"]:checked`)
        ].map(x => x.value);

        const other = document.querySelector(`input[name="${category}_other"]`).value;

        payload[category] = {
            selected,
            other: other.trim()
        };
    });

    const { error } = await supabase
        .from("responses")
        .insert({
            client_id: config.clientId,
            data: payload
        });

    if (error) {
        document.getElementById("status").textContent = "Erreur : " + error.message;
    } else {
        document.getElementById("status").textContent = "Merci ! Votre réponse a été envoyée.";
    }
}

/* ------------ Init ------------ */
loadConfig().then(config => {
    buildForm(config);
    document.getElementById("submitBtn").onclick = () => submitForm(config);
});
</script>

</body>
</html>

